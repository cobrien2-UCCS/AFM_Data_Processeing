# Minimal Gwyddion TIFF → CSV Processing Function (POC)

## Overview
This file defines the minimal, single-function AFM TIFF → CSV processing step using Gwyddion.  
This is intended as the base unit for a new clean repo.

---

## `process_tiff_with_gwyddion`
Minimal preprocessing pipeline:
- Load TIFF into Gwyddion
- Apply simple, deterministic preprocessing (plane level, row flatten, optional median filter)
- Extract 2D numeric array
- Export to CSV with minimal metadata

---

## Pseudocode

```pseudocode
FUNCTION process_tiff_with_gwyddion(input_tiff_path: STRING,
                                    output_root: STRING,
                                    processing_config: DICT) -> STRING
    base_name = STRIP_EXTENSION(BASENAME(input_tiff_path))
    csv_dir   = JOIN_PATH(output_root, "csv")
    ENSURE_DIRECTORY_EXISTS(csv_dir)

    output_csv_path = JOIN_PATH(csv_dir, base_name + "__flattened.csv")

    gwy_app = GWY_INIT_IF_NEEDED()
    data_container = GWY_FILE_LOAD(input_tiff_path)

    IF data_container IS NULL THEN
        RAISE_ERROR("Gwyddion could not load TIFF.")
    END IF

    channel_name = processing_config.channel_name
    channel_id   = SELECT_CHANNEL_ID(data_container, channel_name)
    IF channel_id IS NULL THEN
        channel_id = GET_FIRST_DATA_FIELD_ID(data_container)
    END IF

    field = GWY_DATA_CONTAINER_GET_FIELD(data_container, channel_id)
    IF field IS NULL THEN
        GWY_DATA_UNREF(data_container)
        RAISE_ERROR("No valid field in TIFF.")
    END IF

    IF processing_config.do_plane_level THEN
        field = GWY_PROC_PLANE_LEVEL(field, order=1)
    END IF

    IF processing_config.do_line_correction THEN
        field = GWY_PROC_ROW_FLATTEN(field, method="median")
    END IF

    IF processing_config.do_median_filter THEN
        radius = processing_config.median_radius
        field  = GWY_PROC_MEDIAN_FILTER(field, radius)
    END IF

    nx = GWY_FIELD_GET_XRES(field)
    ny = GWY_FIELD_GET_YRES(field)
    data_array = GWY_FIELD_GET_DATA_2D(field)

    x_real_size = GWY_FIELD_GET_XREAL(field)
    y_real_size = GWY_FIELD_GET_YREAL(field)
    z_units     = GWY_FIELD_GET_ZUNIT(field)

    csv_file = OPEN_FILE_FOR_WRITE(output_csv_path)

    WRITE_LINE(csv_file, "# source_file=" + BASENAME(input_tiff_path))
    WRITE_LINE(csv_file, "# nx=" + nx + ", ny=" + ny)
    WRITE_LINE(csv_file, "# x_real_size=" + x_real_size)
    WRITE_LINE(csv_file, "# y_real_size=" + y_real_size)
    WRITE_LINE(csv_file, "# z_units=" + z_units)
    WRITE_LINE(csv_file, "# processing_steps=" + DESCRIBE_PROCESSING(processing_config))
    WRITE_LINE(csv_file, "")

    FOR row_index FROM 0 TO ny-1 DO
        row_values = []
        FOR col_index FROM 0 TO nx-1 DO
            value = data_array[row_index][col_index]
            row_values.APPEND(FORMAT_FLOAT(value))
        END FOR

        line = JOIN_WITH_COMMAS(row_values)
        WRITE_LINE(csv_file, line)
    END FOR

    CLOSE_FILE(csv_file)
    GWY_DATA_UNREF(data_container)

    RETURN output_csv_path
END FUNCTION
```

---

## Batch Wrapper (Optional)

```pseudocode
FUNCTION batch_process_folder(input_root, output_root, cfg)
    tiff_files = RECURSIVELY_FIND(input_root, pattern="*.tif")

    FOR path IN tiff_files DO
        TRY
            csv_path = process_tiff_with_gwyddion(path, output_root, cfg)
        CATCH e
            LOG_ERROR("FAILED: " + path)
        END TRY
    END FOR
END FUNCTION
```

---

## Notes
- No grid parsing.
- No metadata extraction beyond Gwyddion’s field properties.
- CSV is the “ground truth” layer for downstream analysis.

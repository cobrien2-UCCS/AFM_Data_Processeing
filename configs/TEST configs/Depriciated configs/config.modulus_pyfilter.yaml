# Modulus config that turns on Python-side filtering/export (three_sigma + Chauvenet + min/max).

channel_defaults:
  modulus_family: "modulus"
  topography_family: "height"

modes:
  modulus_basic:
    channel_family: "modulus"
    plane_level: true
    median_size: 3
    line_level_x: false
    line_level_y: false
    clip_percentiles: [0.5, 99.5]
    # Start with no mask to observe raw filtered stats; add masks later if needed.
    mask: null
    stats_filter:
      min_value: 3000.0          # 3 MPa expressed in kPa
      max_value: 40000.0         # 40 MPa expressed in kPa
      exclude_nonpositive: true
      on_empty: "warn"
    # Extra Python-side post-processing + per-image CSV export
    python_data_filtering:
      enable: true
      export_raw_csv: true
      export_filtered_csv: true
      export_dir: "out/debug/pyfilter"
      on_empty: "warn"
      filters:
        - { type: "three_sigma", sigma: 3.0 }
        - { type: "chauvenet" }
        - { type: "min_max", min_value: 3000.0, max_value: 40000.0 }
    metric_type: "modulus"
    units: "kPa"
    expected_units: "kPa"
    on_unit_mismatch: "warn"
    on_missing_units: "skip_row"

grid:
  index_base: 1
  filename_regex: "LOC_RC(?P<row>\\d{3})(?P<col>\\d{3})"

summarize:
  recursive: false

debug:
  enable: true
  level: "info"
  artifacts: ["mask", "leveled", "aligned", "filtered"]
  sample_limit: 5
  out_dir: "out/debug"
  log_fields: ["units", "mask_counts", "stats_counts", "grid", "pyfilter", "pyfilter_steps"]
  raise_on_warn: false
  echo_config: false

csv_modes:
  default_scalar:
    columns:
      - { name: "source_file", from: "core.source_file" }
      - { name: "channel", from: "file.channel", default: "" }
      - { name: "direction", from: "file.direction", default: "" }
      - { name: "grid_id", from: "file.grid_id", default: "" }
      - { name: "date_code", from: "file.date_code", default: "" }
      - { name: "mode", from: "core.mode" }
      - { name: "metric_type", from: "core.metric_type" }
      - { name: "avg_value", from: "core.avg_value" }
      - { name: "std_value", from: "core.std_value" }
      - { name: "units", from: "core.units" }
      - { name: "nx", from: "core.nx" }
      - { name: "ny", from: "core.ny" }
      - { name: "row_idx", from: "grid.row_idx", default: -1 }
      - { name: "col_idx", from: "grid.col_idx", default: -1 }
    on_missing_field: "warn_null"

result_schemas:
  default_scalar:
    from_csv_mode: "default_scalar"
    fields:
      - { field: "source_file", type: "string", column: "source_file" }
      - { field: "channel", type: "string", column: "channel" }
      - { field: "direction", type: "string", column: "direction" }
      - { field: "grid_id", type: "string", column: "grid_id" }
      - { field: "date_code", type: "string", column: "date_code" }
      - { field: "mode", type: "string", column: "mode" }
      - { field: "metric_type", type: "string", column: "metric_type" }
      - { field: "avg_value", type: "float", column: "avg_value" }
      - { field: "std_value", type: "float", column: "std_value" }
      - { field: "units", type: "string", column: "units" }
      - { field: "nx", type: "int", column: "nx" }
      - { field: "ny", type: "int", column: "ny" }
      - { field: "row_idx", type: "int", column: "row_idx" }
      - { field: "col_idx", type: "int", column: "col_idx" }

plotting_modes:
  sample_bar_with_error:
    result_schema: "default_scalar"
    recipe: "sample_bar_with_error"
    title: "Sample Means (kPa)"
    ylabel: "Modulus (kPa)"
  heatmap_grid:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    title: "Grid Heatmap (kPa)"
    colorbar_label: "avg_value"
    duplicate_policy: "warn_mean"
  heatmap_grid_avg_with_std_overlay:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    value_field: "avg_value"
    title: "Grid Heatmap (kPa) + Std Overlay"
    colorbar_label: "avg_value"
    duplicate_policy: "warn_mean"
    overlay_std:
      enable: true
      value_field: "std_value"
      text_fmt: "{val:.0f}"
      sigma_bins: [1.0, 2.0, 3.0, 5.0]
      colors: ["#006400", "#ffa500", "#ff4500", "#8b0000", "#000000"]
      legend: true
  heatmap_grid_std:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    value_field: "std_value"
    title: "Grid Heatmap (Std, kPa)"
    colorbar_label: "std_value"
    duplicate_policy: "warn_mean"
    cmap: "magma"
    discrete_bins: null
    overlay_std:
      enable: true
      value_field: "std_value"
      text_fmt: "{val:.1f}"
      sigma_bins: [1.0, 2.0, 3.0, 5.0]
      colors: ["#006400", "#ffa500", "#ff4500", "#8b0000", "#000000"]
  heatmap_grid_cv:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    value_field: "cv_value"
    title: "Grid Heatmap (CV = std/mean)"
    colorbar_label: "CV (std/mean)"
    duplicate_policy: "warn_mean"
    cmap: "plasma"
    overlay_hatch:
      enable: true
      value_field: "cv_value"
      threshold: 0.2
      direction: "gt"
      hatch: "///"
      facecolor: "none"
      edgecolor: "#000000"
      alpha: 0.35
  heatmap_grid_range:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    value_field: "range_value"
    title: "Grid Heatmap (Range max-min)"
    colorbar_label: "range"
    duplicate_policy: "warn_mean"
    cmap: "cividis"
  heatmap_grid_avg_two_panel:
    result_schema: "default_scalar"
    recipe: "heatmap_two_panel"
    left_field: "avg_value"
    right_field: "std_value"
    left_title: "Mean (kPa)"
    right_title: "Std (kPa)"
    left_colorbar_label: "avg_value"
    right_colorbar_label: "std_value"
    duplicate_policy: "warn_mean"
  heatmap_grid_avg_with_std_bubbles:
    result_schema: "default_scalar"
    recipe: "heatmap_grid_bubbles"
    value_field: "avg_value"
    title: "Grid Heatmap (kPa) + Std Bubbles"
    colorbar_label: "avg_value"
    duplicate_policy: "warn_mean"
    overlay_bubbles:
      enable: true
      value_field: "std_value"
      sigma_bins: [1.0, 2.0, 3.0, 5.0]
      colors: ["#006400", "#ffa500", "#ff4500", "#8b0000", "#000000"]
      max_sigma: 5.0
      size_min: 40
      size_max: 260
      alpha: 0.85
      edgecolor: "#000000"
      legend: true

profiles:
  modulus_pyfilter:
    processing_mode: "modulus_basic"
    csv_mode: "default_scalar"
    plotting_modes:
      - "sample_bar_with_error"
      - "heatmap_grid"
      - "heatmap_grid_std"
      - "heatmap_grid_avg_with_std_overlay"
      - "heatmap_grid_avg_with_std_bubbles"
      - "heatmap_grid_cv"
      - "heatmap_grid_range"
      - "heatmap_grid_avg_two_panel"

unit_conversions:
  modulus_basic:
    kPa: { target: "kPa", factor: 1.0 }
    MPa: { target: "kPa", factor: 1000.0 }
    GPa: { target: "kPa", factor: 1e6 }
    Pa:  { target: "kPa", factor: 0.001 }
  modulus_pyfilter:
    kPa: { target: "kPa", factor: 1.0 }
    MPa: { target: "kPa", factor: 1000.0 }
    GPa: { target: "kPa", factor: 1e6 }
    Pa:  { target: "kPa", factor: 0.001 }

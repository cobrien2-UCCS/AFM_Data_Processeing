# Channel defaults inform selection of data fields in pygwy/Gwyddion.
channel_defaults:
  modulus_family: "modulus"
  topography_family: "height"

# Processing modes (Gwyddion-first).
modes:
  modulus_basic:
    channel_family: "modulus"
    plane_level: true
    median_size: 3                 # median filter size (odd int); set null to skip
    # Line correction (Align Rows)
    # line_correct:
    #   enable: true
    #   method: "median"            # defaults to median if omitted
    #   direction: "horizontal"
    line_level_x: false
    line_level_y: false
    clip_percentiles: null
    # Mask applied before stats (units: raw data, typically MPa pre-conversion).
    mask:
      enable: true
      method: "threshold"
      threshold: 0.1               # keep values >= 0.1 MPa (adjust as needed)
      direction: "above"
      invert: false
      on_empty: "error"
    # Value include/exclude for stats (still in raw units, typically MPa).
    stats_filter:
      min_value: 0.5               # exclude below 0.5 MPa
      max_value: 70.0              # exclude above 70 MPa
      exclude_nonpositive: true
      on_empty: "warn"             # warn if all pixels are removed
    metric_type: "modulus"
    units: "MPa"
    expected_units: "MPa"          # validate in MPa
    on_unit_mismatch: "error"

  topography_flat:
    channel_family: "height"
    plane_level: true
    median_size: 3
    line_level_x: false
    line_level_y: false
    clip_percentiles: null
    # Mask/template left disabled; enable and tune if needed.
    # mask:
    #   enable: true
    #   method: "threshold"
    #   threshold: 0.0
    #   direction: "above"
    #   on_empty: "error"
    metric_type: "topography_height"
    units: "nm"
    expected_units: "nm"
    on_unit_mismatch: "error"

  particle_count_basic:
    channel_family: "height"
    plane_level: false
    metric_type: "particle_count"
    threshold: null
    units: "count"
    expected_units: "count"
    on_unit_mismatch: "error"

  raw_noop:
    channel_family: null
    plane_level: false
    metric_type: "raw"
    units: "a.u."

# Grid config for deriving row/col indices from filenames.
grid:
  index_base: 1
  filename_regex: "LOC_RC(?P<row>\\d{3})(?P<col>\\d{3})"

# Summarization options
summarize:
  recursive: false

# Debug/diagnostics options
debug:
  enable: false
  level: "info"
  artifacts: []
  sample_limit: 3
  out_dir: "out/debug"
  log_fields: ["units", "mask_counts", "stats_counts"]
  raise_on_warn: false
  echo_config: false

# Optional input filtering for manifest generation.
# input_filters:
#   include_regex: ["Backward"]
#   exclude_regex: ["Forward"]

# CSV modes
csv_modes:
  default_scalar:
    columns:
      - { name: "source_file", from: "core.source_file" }
      - { name: "channel", from: "file.channel", default: "" }
      - { name: "direction", from: "file.direction", default: "" }
      - { name: "grid_id", from: "file.grid_id", default: "" }
      - { name: "date_code", from: "file.date_code", default: "" }
      - { name: "mode", from: "core.mode" }
      - { name: "metric_type", from: "core.metric_type" }
      - { name: "avg_value", from: "core.avg_value" }
      - { name: "std_value", from: "core.std_value" }
      - { name: "units", from: "core.units" }
      - { name: "nx", from: "core.nx" }
      - { name: "ny", from: "core.ny" }
      - { name: "row_idx", from: "grid.row_idx", default: -1 }
      - { name: "col_idx", from: "grid.col_idx", default: -1 }
    on_missing_field: "warn_null"

  particle_metrics:
    columns:
      - { name: "source_file", from: "core.source_file" }
      - { name: "mode", from: "core.mode" }
      - { name: "metric_type", from: "core.metric_type" }
      - { name: "count_total", from: "particle.count_total" }
      - { name: "count_density", from: "particle.count_density" }
      - { name: "mean_diam_px", from: "particle.mean_diameter_px" }
      - { name: "std_diam_px", from: "particle.std_diameter_px" }
      - { name: "nx", from: "core.nx" }
      - { name: "ny", from: "core.ny" }
      - { name: "row_idx", from: "grid.row_idx", default: -1 }
      - { name: "col_idx", from: "grid.col_idx", default: -1 }
    on_missing_field: "warn_null"

# Result schemas
result_schemas:
  default_scalar:
    from_csv_mode: "default_scalar"
    fields:
      - { field: "source_file", type: "string", column: "source_file" }
      - { field: "channel", type: "string", column: "channel" }
      - { field: "direction", type: "string", column: "direction" }
      - { field: "grid_id", type: "string", column: "grid_id" }
      - { field: "date_code", type: "string", column: "date_code" }
      - { field: "mode", type: "string", column: "mode" }
      - { field: "metric_type", type: "string", column: "metric_type" }
      - { field: "avg_value", type: "float", column: "avg_value" }
      - { field: "std_value", type: "float", column: "std_value" }
      - { field: "units", type: "string", column: "units" }
      - { field: "nx", type: "int", column: "nx" }
      - { field: "ny", type: "int", column: "ny" }
      - { field: "row_idx", type: "int", column: "row_idx" }
      - { field: "col_idx", type: "int", column: "col_idx" }

  particle_metrics:
    from_csv_mode: "particle_metrics"
    fields:
      - { field: "source_file", type: "string", column: "source_file" }
      - { field: "mode", type: "string", column: "mode" }
      - { field: "metric_type", type: "string", column: "metric_type" }
      - { field: "count_total", type: "int", column: "count_total" }
      - { field: "count_density", type: "float", column: "count_density" }
      - { field: "mean_diam_px", type: "float", column: "mean_diam_px" }
      - { field: "std_diam_px", type: "float", column: "std_diam_px" }
      - { field: "nx", type: "int", column: "nx" }
      - { field: "ny", type: "int", column: "ny" }
      - { field: "row_idx", type: "int", column: "row_idx" }
      - { field: "col_idx", type: "int", column: "col_idx" }

# Plotting modes
plotting_modes:
  sample_bar_with_error:
    result_schema: "default_scalar"
    recipe: "sample_bar_with_error"
    title: "Sample Means"
    ylabel: "Value"
  histogram_avg:
    result_schema: "default_scalar"
    recipe: "histogram_avg"
    bins: 20
    title: "Average Distribution"
  scatter_avg_vs_std:
    result_schema: "default_scalar"
    recipe: "scatter_avg_vs_std"
    title: "Avg vs Std"
  mode_comparison_bar:
    result_schema: "default_scalar"
    recipe: "mode_comparison_bar"
    title: "Mode Comparison"
  heatmap_grid:
    result_schema: "default_scalar"
    recipe: "heatmap_grid"
    title: "Grid Heatmap"
    colorbar_label: "avg_value"
    duplicate_policy: "warn_mean"

# Profiles
profiles:
  modulus_grid_masked:
    processing_mode: "modulus_basic"
    csv_mode: "default_scalar"
    plotting_modes: ["sample_bar_with_error", "heatmap_grid"]

# Unit conversions
unit_conversions:
  modulus_basic:
    MPa: { target: "MPa", factor: 1.0 }
    GPa: { target: "MPa", factor: 1000.0 }
    kPa: { target: "MPa", factor: 0.001 }
    Pa:  { target: "MPa", factor: 1e-6 }
